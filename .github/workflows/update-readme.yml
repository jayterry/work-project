name: Update README Activity

on:
  workflow_dispatch:        # æ‰‹å‹•è§¸ç™¼
  schedule:
    - cron: "0 * * * *"     # æ¯å°æ™‚è·‘ä¸€æ¬¡ï¼Œå¯è‡ªè¡Œèª¿æ•´

permissions:
  contents: write

# æƒ³æ”¹é¡¯ç¤ºå¹¾ç­†æ´»å‹•ï¼Œæ”¹é€™è£¡ï¼ˆå­—ä¸²ä¹Ÿå¯ï¼‰
env:
  MAX_ITEMS: "8"

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # ç”¨ä½ çš„ PATï¼ˆREPO_TOKENï¼‰checkout & pushï¼Œæ¯” GITHUB_TOKEN æ›´é€šç”¨
          token: ${{ secrets.REPO_TOKEN }}

      # ç”¨ github-script ç›´æ¥å‘¼å« Octokitï¼Œç„¡éœ€å¦è£å¥—ä»¶ï¼Œæœ€ç©©
      - name: Build activity markdown
        uses: actions/github-script@v7
        id: build
        with:
          github-token: ${{ secrets.REPO_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const max   = parseInt(process.env.MAX_ITEMS || '8', 10);
            const repoUrl = `https://github.com/${owner}/${repo}`;

            // å–è¼ƒå¤šç­†ï¼Œå†è‡ªè¡Œéæ¿¾/é™é‡
            const { data: events } = await github.rest.activity.listRepoEvents({
              owner, repo, per_page: 50
            });

            const lines = [];
            for (const e of events) {
              if (lines.length >= max) break;

              // è·³éæ©Ÿå™¨äººè‡ªå·±æ¨çš„æ´»å‹•ï¼Œé¿å…å™ªéŸ³
              if (e.actor?.login === 'github-actions[bot]') continue;

              switch (e.type) {
                case 'IssuesEvent': {
                  const issue = e.payload.issue;
                  if (!issue) break;
                  const act = e.payload.action; // opened/closed/reopened
                  const emoji = act === 'opened' ? 'ğŸŸ¢' : act === 'closed' ? 'ğŸ”´' : 'ğŸŸ¡';
                  lines.push(`- ${emoji} **${act}** issue [#${issue.number}](${issue.html_url}) â€” _${issue.title}_`);
                  break;
                }
                case 'PullRequestEvent': {
                  const pr = e.payload.pull_request;
                  if (!pr) break;
                  let act = e.payload.action;
                  let emoji = 'ğŸ“Œ';
                  if (act === 'closed' && pr.merged) { act = 'merged'; emoji = 'ğŸ‰'; }
                  else if (act === 'closed') { emoji = 'âŒ'; }
                  lines.push(`- ${emoji} **${act}** PR [#${pr.number}](${pr.html_url}) â€” _${pr.title}_`);
                  break;
                }
                case 'PushEvent': {
                  const branch = e.payload.ref?.replace('refs/heads/', '') || 'main';
                  const count  = e.payload.commits?.length || 1;
                  lines.push(`- ğŸš€ pushed **${count}** commit(s) to [${branch}](${repoUrl}/commits/${branch})`);
                  break;
                }
                default:
                  // éœ€è¦å¯å†æ“´å……ï¼ˆReleaseEventã€CreateEventâ€¦ï¼‰
              }
            }

            const heading = '## ğŸ”¥ Recent Activities';
            const body = (lines.length ? lines.join('\n') : '- â„¹ï¸ No recent activity.').trim();

            const fs = require('fs');
            fs.writeFileSync('activity.md', `${heading}\n${body}\n`);

      - name: Update README between markers
        run: |
          # ä»¥ activity.md è¦†å¯« README ä¸­çš„æ¨™è¨˜å€å¡Š
          awk 'BEGIN{start=0} /<!--ACTIVITY-START-->/ {print; while((getline line < "activity.md") > 0) print line; start=1; next} /<!--ACTIVITY-END-->/ {if(!start) print} !/<!--ACTIVITY-START-->/ && !/<!--ACTIVITY-END-->/' README.md > README.new
          mv README.new README.md

      - name: Commit changes
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "chore: update GitHub activity" || echo "No changes to commit"
          git push
